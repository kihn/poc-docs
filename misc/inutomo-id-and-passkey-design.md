# イヌトモNow：ID設計とパスキー認証の整理（最新版）

## 前提
イヌトモNow は以下の特徴を持つアプリである。

- モバイル専用（Flutter）
- メイン機能は「イヌともが今どこを散歩しているか分かる」
- 高リスク情報（リアルタイム位置）を扱う
- メールアドレスを前提としない設計を目指す
- 認証方式の主軸は **パスキー（Passkey / WebAuthn）**

---

## 結論サマリ
- Flutter側で **仮ID（localGuestId）を生成するのはOK**
- **正式なユーザーID（userId）は必ずサーバで発行**
- パスキー登録が「アカウント誕生の瞬間」
- 認証後は **JWTで一貫して認可**
- 認証前のワンコプロフィールは **サーバに送らない**

---

## IDの役割分担

### localGuestId（ゲストID）
- Flutterアプリ初回起動時に生成（UUID v4 推奨）
- 端末内データをまとめるための仮名札
- 本人性は一切持たない
- 認証前のワンコプロフィールや散歩ログと紐づく
- サーバは「本人識別」には使わない

👉 **端末内専用ID**

---

### userId（正式ユーザーID）
- パスキー登録成功後に **バックエンドで発行**
- Firestoreの主キー
- 認証・権限・通報・BANの単位
- クライアントから任意指定させない

👉 **社会的に通用するID**

---

## 正しいフロー（推奨）

### 1. ゲスト開始
- Flutterが localGuestId を生成・保存
- ワンコプロフィール・散歩履歴は端末内のみ
- サーバには個体情報を送らない
- 匿名・集計レベルの位置情報のみ送信可

---

### 2. パスキー登録（本人性付与）
- Flutter → バックエンドへ登録 options 要求
- 端末でパスキー作成（生体認証）
- バックエンドで検証成功
- **サーバが userId を発行**
- userId を含む JWT をクライアントへ返却

👉 この瞬間が「アカウント登録」

---

### 3. 昇格（bootstrap）
- Flutterが JWT を付けてAPI呼び出し
- localGuestId とローカルデータを送信
- サーバは JWT から userId を確定
- データを userId に紐づけて保存
- localGuestId の役割はここで終了

---

### 4. 認証後の世界
- 以後のAPI呼び出しはすべて JWT ベース
- クライアントは userId を直接指定しない
- パスキーは「ログイン手段」として継続利用

---

## なぜこの設計が安全か
- クライアント申告IDによるなりすましを防止
- 認証前データがサーバに残らない
- ゲスト離脱時に孤児データが発生しない
- 認証方式を将来追加・変更しやすい

---

## やってはいけないこと（NG）
- Flutter側で userId を生成して送る
- 認証前に犬プロフィールや写真をアップロード
- localGuestId をサーバの主キーとして扱う
- JWTなしで userId を信頼する

---

## 位置共有機能との関係
- リアルタイム位置表示は **認証後のみ**
- ゲストは「いる感」レベルのぼかし表示のみ
- イヌとも関係成立後に精度を段階的に解放

---

## 設計思想まとめ
- 登録は「入口」ではなく「要所」
- 認証は義務ではなく「保険」
- 正面玄関はパスキー一本
- 非常口（復旧手段）は奥に用意

イヌトモNow は  
**「体験的にはパスキーだけのアプリ」**  
として成立させることができる。
